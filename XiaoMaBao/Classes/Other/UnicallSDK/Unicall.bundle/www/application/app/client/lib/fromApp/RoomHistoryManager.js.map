{"version":3,"sources":["meteor://ðŸ’»app/client/lib/fromApp/RoomHistoryManager.js"],"names":[],"mappings":"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","file":"/client/lib/fromApp/RoomHistoryManager.js","sourcesContent":["// Generated by CoffeeScript 1.10.0\n(function() {\n  this.RoomHistoryManager = new ((function() {\n    var clear, defaultLimit, getMore, getMoreIfIsEmpty, getRoom, hasMore, histories, isLoading;\n\n    function _Class() {}\n\n    defaultLimit = 50;\n\n    histories = {};\n\n    getRoom = function(rid) {\n      if (histories[rid] == null) {\n        histories[rid] = {\n          hasMore: ReactiveVar(true),\n          isLoading: ReactiveVar(false),\n          loaded: 0\n        };\n      }\n      return histories[rid];\n    };\n\n    getMore = function(rid, limit) {\n      var lastMessage, room, ts;\n      if (limit == null) {\n        limit = defaultLimit;\n      }\n      room = getRoom(rid);\n      if (room.hasMore.curValue !== true) {\n        return;\n      }\n      room.isLoading.set(true);\n      lastMessage = ChatMessage.findOne({\n        rid: rid\n      }, {\n        sort: {\n          ts: 1\n        }\n      });\n      if (lastMessage != null) {\n        ts = lastMessage.ts;\n      } else {\n        ts = new Date;\n      }\n      return Meteor.call('loadHistory', rid, ts, limit, void 0, function(err, result) {\n        var i, item, len, ref;\n        ref = (result != null ? result.messages : void 0) || [];\n        for (i = 0, len = ref.length; i < len; i++) {\n          item = ref[i];\n          ChatMessage.upsert({\n            _id: item._id\n          }, item);\n        }\n        room.isLoading.set(false);\n        room.loaded += result.messages.length;\n        if (result.messages.length < limit) {\n          return room.hasMore.set(false);\n        }\n      });\n    };\n\n    hasMore = function(rid) {\n      var room;\n      room = getRoom(rid);\n      return room.hasMore.get();\n    };\n\n    getMoreIfIsEmpty = function(rid) {\n      var room;\n      room = getRoom(rid);\n      if (room.loaded === 0) {\n        return getMore(rid);\n      }\n    };\n\n    isLoading = function(rid) {\n      var room;\n      room = getRoom(rid);\n      return room.isLoading.get();\n    };\n\n    clear = function(rid) {\n      ChatMessage.remove({\n        rid: rid\n      });\n      if (histories[rid] != null) {\n        histories[rid].hasMore.set(true);\n        histories[rid].isLoading.set(false);\n        return histories[rid].loaded = 0;\n      }\n    };\n\n    _Class.prototype.getMore = getMore;\n\n    _Class.prototype.getMoreIfIsEmpty = getMoreIfIsEmpty;\n\n    _Class.prototype.hasMore = hasMore;\n\n    _Class.prototype.isLoading = isLoading;\n\n    _Class.prototype.clear = clear;\n\n    return _Class;\n\n  })());\n\n}).call(this);\n"]}