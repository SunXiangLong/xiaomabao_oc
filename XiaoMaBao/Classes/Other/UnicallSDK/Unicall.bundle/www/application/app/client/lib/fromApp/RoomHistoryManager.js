(function(){

/////////////////////////////////////////////////////////////////////////
//                                                                     //
// client/lib/fromApp/RoomHistoryManager.js                            //
//                                                                     //
/////////////////////////////////////////////////////////////////////////
                                                                       //
// Generated by CoffeeScript 1.10.0                                    //
(function () {                                                         // 2
  this.RoomHistoryManager = new ((function () {                        // 3
    var clear, defaultLimit, getMore, getMoreIfIsEmpty, getRoom, hasMore, histories, isLoading;
                                                                       //
    function _Class() {}                                               // 6
                                                                       //
    defaultLimit = 50;                                                 // 8
                                                                       //
    histories = {};                                                    // 10
                                                                       //
    getRoom = function (rid) {                                         // 12
      if (histories[rid] == null) {                                    // 13
        histories[rid] = {                                             // 14
          hasMore: ReactiveVar(true),                                  // 15
          isLoading: ReactiveVar(false),                               // 16
          loaded: 0                                                    // 17
        };                                                             //
      }                                                                //
      return histories[rid];                                           // 20
    };                                                                 //
                                                                       //
    getMore = function (rid, limit) {                                  // 23
      var lastMessage, room, ts;                                       // 24
      if (limit == null) {                                             // 25
        limit = defaultLimit;                                          // 26
      }                                                                //
      room = getRoom(rid);                                             // 28
      if (room.hasMore.curValue !== true) {                            // 29
        return;                                                        // 30
      }                                                                //
      room.isLoading.set(true);                                        // 32
      lastMessage = ChatMessage.findOne({                              // 33
        rid: rid                                                       // 34
      }, {                                                             //
        sort: {                                                        // 36
          ts: 1                                                        // 37
        }                                                              //
      });                                                              //
      if (lastMessage != null) {                                       // 40
        ts = lastMessage.ts;                                           // 41
      } else {                                                         //
        ts = new Date();                                               // 43
      }                                                                //
      return Meteor.call('loadHistory', rid, ts, limit, void 0, function (err, result) {
        var i, item, len, ref;                                         // 46
        ref = (result != null ? result.messages : void 0) || [];       // 47
        for (i = 0, len = ref.length; i < len; i++) {                  // 48
          item = ref[i];                                               // 49
          ChatMessage.upsert({                                         // 50
            _id: item._id                                              // 51
          }, item);                                                    //
        }                                                              //
        room.isLoading.set(false);                                     // 54
        room.loaded += result.messages.length;                         // 55
        if (result.messages.length < limit) {                          // 56
          return room.hasMore.set(false);                              // 57
        }                                                              //
      });                                                              //
    };                                                                 //
                                                                       //
    hasMore = function (rid) {                                         // 62
      var room;                                                        // 63
      room = getRoom(rid);                                             // 64
      return room.hasMore.get();                                       // 65
    };                                                                 //
                                                                       //
    getMoreIfIsEmpty = function (rid) {                                // 68
      var room;                                                        // 69
      room = getRoom(rid);                                             // 70
      if (room.loaded === 0) {                                         // 71
        return getMore(rid);                                           // 72
      }                                                                //
    };                                                                 //
                                                                       //
    isLoading = function (rid) {                                       // 76
      var room;                                                        // 77
      room = getRoom(rid);                                             // 78
      return room.isLoading.get();                                     // 79
    };                                                                 //
                                                                       //
    clear = function (rid) {                                           // 82
      ChatMessage.remove({                                             // 83
        rid: rid                                                       // 84
      });                                                              //
      if (histories[rid] != null) {                                    // 86
        histories[rid].hasMore.set(true);                              // 87
        histories[rid].isLoading.set(false);                           // 88
        return histories[rid].loaded = 0;                              // 89
      }                                                                //
    };                                                                 //
                                                                       //
    _Class.prototype.getMore = getMore;                                // 93
                                                                       //
    _Class.prototype.getMoreIfIsEmpty = getMoreIfIsEmpty;              // 95
                                                                       //
    _Class.prototype.hasMore = hasMore;                                // 97
                                                                       //
    _Class.prototype.isLoading = isLoading;                            // 99
                                                                       //
    _Class.prototype.clear = clear;                                    // 101
                                                                       //
    return _Class;                                                     // 103
  })())();                                                             //
}).call(this);                                                         //
/////////////////////////////////////////////////////////////////////////

}).call(this);
