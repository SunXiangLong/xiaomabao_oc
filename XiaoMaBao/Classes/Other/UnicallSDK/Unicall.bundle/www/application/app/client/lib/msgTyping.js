(function(){

/////////////////////////////////////////////////////////////////////////
//                                                                     //
// client/lib/msgTyping.js                                             //
//                                                                     //
/////////////////////////////////////////////////////////////////////////
                                                                       //
// Generated by CoffeeScript 1.10.0                                    //
(function () {                                                         // 2
  this.MsgTyping = (function () {                                      // 3
    var addStream, dep, get, renew, renewTimeout, selfTyping, start, stop, stream, timeout, timeouts, usersTyping;
    stream = new Meteor.Stream('typing');                              // 5
    timeout = 15000;                                                   // 6
    timeouts = {};                                                     // 7
    renew = true;                                                      // 8
    renewTimeout = 10000;                                              // 9
    selfTyping = new ReactiveVar(false);                               // 10
    usersTyping = {};                                                  // 11
    dep = new Tracker.Dependency();                                    // 12
    addStream = function (room) {                                      // 13
      var ref;                                                         // 14
      if (_.isEmpty((ref = usersTyping[room]) != null ? ref.users : void 0)) {
        usersTyping[room] = {                                          // 16
          users: {}                                                    // 17
        };                                                             //
        return stream.on(room, function (typing) {                     // 19
          var ref1, users;                                             // 20
          if ((typing != null ? typing.username : void 0) !== ((ref1 = Meteor.user()) != null ? ref1.username : void 0)) {
            if (typing.start) {                                        // 22
              users = usersTyping[room].users;                         // 23
              users[typing.username] = Meteor.setTimeout(function () {
                delete users[typing.username];                         // 25
                usersTyping[room].users = users;                       // 26
                return dep.changed();                                  // 27
              }, timeout);                                             //
              usersTyping[room].users = users;                         // 29
              return dep.changed();                                    // 30
            } else if (typing.stop) {                                  //
              users = usersTyping[room].users;                         // 32
              delete users[typing.username];                           // 33
              usersTyping[room].users = users;                         // 34
              return dep.changed();                                    // 35
            }                                                          //
          }                                                            //
        });                                                            //
      }                                                                //
    };                                                                 //
    Tracker.autorun(function () {                                      // 41
      if (visitor.getRoom()) {                                         // 42
        return addStream(visitor.getRoom());                           // 43
      }                                                                //
    });                                                                //
    start = function (room) {                                          // 46
      var ref;                                                         // 47
      if (!renew) {                                                    // 48
        return;                                                        // 49
      }                                                                //
      setTimeout(function () {                                         // 51
        return renew = true;                                           // 52
      }, renewTimeout);                                                //
      renew = false;                                                   // 54
      selfTyping.set(true);                                            // 55
      stream.emit('typing', {                                          // 56
        room: room,                                                    // 57
        username: (ref = Meteor.user()) != null ? ref.username : void 0,
        start: true                                                    // 59
      });                                                              //
      clearTimeout(timeouts[room]);                                    // 61
      return timeouts[room] = Meteor.setTimeout(function () {          // 62
        return stop(room);                                             // 63
      }, timeout);                                                     //
    };                                                                 //
    stop = function (room) {                                           // 66
      var ref;                                                         // 67
      renew = true;                                                    // 68
      selfTyping.set(false);                                           // 69
      if ((timeouts != null ? timeouts[room] : void 0) != null) {      // 70
        clearTimeout(timeouts[room]);                                  // 71
        timeouts[room] = null;                                         // 72
      }                                                                //
      return stream.emit('typing', {                                   // 74
        room: room,                                                    // 75
        username: (ref = Meteor.user()) != null ? ref.username : void 0,
        stop: true                                                     // 77
      });                                                              //
    };                                                                 //
    get = function (room) {                                            // 80
      var users;                                                       // 81
      dep.depend();                                                    // 82
      if (!usersTyping[room]) {                                        // 83
        usersTyping[room] = {                                          // 84
          users: {}                                                    // 85
        };                                                             //
      }                                                                //
      users = usersTyping[room].users;                                 // 88
      return _.keys(users) || [];                                      // 89
    };                                                                 //
    return {                                                           // 91
      start: start,                                                    // 92
      stop: stop,                                                      // 93
      get: get,                                                        // 94
      selfTyping: selfTyping                                           // 95
    };                                                                 //
  })();                                                                //
}).call(this);                                                         //
/////////////////////////////////////////////////////////////////////////

}).call(this);
