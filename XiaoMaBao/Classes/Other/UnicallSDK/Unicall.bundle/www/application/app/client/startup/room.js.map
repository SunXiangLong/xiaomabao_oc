{"version":3,"sources":["meteor://💻app/client/startup/room.js"],"names":[],"mappings":"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","file":"/client/startup/room.js","sourcesContent":["// Generated by CoffeeScript 1.10.0\n(function () {\n  var msgStream, notifyStream, checkInvalidMessage,autoRunCount;\n\n  msgStream = new Meteor.Stream('messages');\n  this.notifyStream = new Meteor.Stream('notify-room');\n  checkInvalidMessage = false;\n  autoRunCount=0;\n\n  Session.set(\"hasSendMsg\", false);\n\n  Tracker.autorun(function () {\n    autoRunCount++;\n    console.log(\"visitor start up  autoRun:\", autoRunCount,visitor.getRoom());\n\n    if (visitor.getRoom() != null) {\n      //定义监听 Message.Stream 当有消息进来时 在本地mini插入消息数据\n      //目前，访客端消息在刷新之后会丢失，因此，初始化时把未读消息设置为0\n      console.log(\"regis event\");\n      localStorage.setItem('unreadMessageNumber', 0)\n      msgStream.on(visitor.getRoom(), function (msg) {\n        if (msg.t === 'sys') {\n          if (msg.msg = 'AgentOffline')\n            showError('您的坐席下线了!')\n        }\n        else {\n          hideError();\n          if (msg.userId !== Meteor.userId()) {\n            if (ChatMessage.find({_id: msg._id}).count() === 0) {\n              unread = localStorage.getItem('unreadMessageNumber');\n              if (unread !== undefined && unread !== null)\n                localStorage.setItem('unreadMessageNumber', parseInt(unread) + 1)\n              else\n                localStorage.setItem('unreadMessageNumber', 1)\n            }\n            var msgcount = localStorage.getItem('unreadMessageNumber');\n\n            if(Session.get('livechat-closed') === true){\n              $(\".msgcount span\").html(msgcount > 99 ? 99 : msgcount);\n              $(\".msgcount\").show();\n            }\n          }\n          if(msg.type !== \"merchandise\")\n            if(ChatMessage.findOne({_id: msg._id})){\n              var obj={}\n              for(var k in msg){\n                if(k !== \"_id\"){\n                  obj[k]=msg[k];\n                }\n              }\n              obj.temp = false;\n              ChatMessage.update({\n                _id: msg._id\n              }, {$set:obj});\n            }else{\n              ChatMessage.insert(msg);\n              outerAgent.noticeNewMsg(msg);\n            }\n          if (ChatMessage.find({rid: visitor.getRoom()}).count() === 1) {\n            Session.set('startTime', msg.ts)\n          }\n          if (checkInvalidMessage === false) {\n            checkInvalidMessage = true;\n            ChatMessage.remove({u: {_id: Meteor.userId(), username: 'visitor'}});\n          }\n        }\n      });\n      csvControler.listen(visitor.getRoom());\n\n\n      //notifyStream.on(visitor.getRoom() + \"/hide\", function (rid) {\n      //  console.log(\"hide your room\", rid);\n      //  //showError(Session.get(\"WebChatConfig\").closing);\n      //    Session.set(\"whoEndMsg\", \"agent\");\n      //    Session.set(\"roomHasHided\", true);\n      //    $(\".xCover\").css(\"display\", \"block\");\n      //\n      //});\n\n    }else{\n      console.log(\"not regis event\");\n    }\n  });\n\n}).call(this);\n"]}