(function(){

/////////////////////////////////////////////////////////////////////////
//                                                                     //
// client/startup/history.js                                           //
//                                                                     //
/////////////////////////////////////////////////////////////////////////
                                                                       //
/**                                                                    //
 * Created by lil on 16-3-8.                                           //
 */                                                                    //
// Generated by CoffeeScript 1.10.0                                    //
(function () {                                                         // 5
  var clazz = function () {                                            // 6
    var currentPage = 1;                                               // 7
    //TimeSync not ready yet                                           //
    var clientInitTime = null;                                         // 9
    var username = undefined;                                          // 10
    var hasRecord = true;                                              // 11
    var loading = false;                                               // 12
    var started = false;                                               // 13
    this.load = function (after) {                                     // 14
      console.log("trigger load history ->" + new Date());             // 15
      console.log("currentPage ->" + currentPage);                     // 16
      console.log("hasRecord ->" + hasRecord);                         // 17
      if (hasRecord === true && loading === false) {                   // 18
        loading = true;                                                // 19
        Session.set('refresh-notice', 'loading');                      // 20
        //default page size is 20 set by server                        //
        Meteor.call('loadMessagesByVisitorUserNameByEndTimeLivechat', username, clientInitTime, currentPage, function (e, r) {
          if (e) console.log(e);else {                                 // 23
            //if clientInitTime is null,server will return new date of server as ct
            if (clientInitTime === null) clientInitTime = r.ct;        // 27
            if (r.hasMore === false) {                                 // 29
              hasRecord = false;                                       // 30
              Session.set('refresh-notice', 'loaded');                 // 31
            }                                                          //
            r.records.forEach(function (record) {                      // 33
              ChatMessage.upsert({                                     // 34
                _id: record._id                                        // 35
              }, record);                                              //
            });                                                        //
            currentPage++;                                             // 38
          }                                                            //
          if (after) after(hasRecord);                                 // 40
          //at last                                                    //
          loading = false;                                             // 43
        });                                                            //
      } else {                                                         //
        //if(after)                                                    //
        //  after();                                                   //
      }                                                                //
    };                                                                 //
    this.start = function (uname) {                                    // 50
      if (started === false) {                                         // 51
        username = uname;                                              // 52
        this.load(function () {                                        // 53
          started = true;                                              // 54
        });                                                            //
      }                                                                //
    };                                                                 //
  };                                                                   //
  var stage = this;                                                    // 60
  if (Meteor.user()) {                                                 // 61
    stage.CharRecords = new clazz();                                   // 62
    CharRecords.start(Meteor.user().username);                         // 63
  } else Accounts.onLogin(function () {                                //
    stage.CharRecords = new clazz();                                   // 66
    CharRecords.start(Meteor.user().username);                         // 67
  });                                                                  //
}).call(this);                                                         //
/////////////////////////////////////////////////////////////////////////

}).call(this);
