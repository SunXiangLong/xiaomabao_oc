{"version":3,"sources":["meteor://💻app/client/methods/slingshotUpload.coffee"],"names":[],"mappings":"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","file":"/client/methods/slingshotUpload.coffee.js","sourcesContent":["S3UpdatedCache ={}\nreadAsDataURL = (file, callback) ->\n\treader = new FileReader()\n\treader.onload = (ev) ->\n\t\tcallback ev.target.result, file\n\n\treader.readAsDataURL file\n\nreadAsArrayBuffer = (file, callback) ->\n\treader = new FileReader()\n\treader.onload = (ev) ->\n\t\tcallback ev.target.result, file\n\n\treader.readAsArrayBuffer file\nsend = (uploader,file,callback) ->\n\tif (file instanceof window.File) is false and (file instanceof window.Blob) is false\n\t\tthrow new Meteor.Error \"Not a file\", \"Not a file\"\n\n\tdummy=()->\n\t\tuploader.file = file\n\t\tuploader.request (error, instructions) ->\n\t\t\tif error\n\t\t\t\treturn callback error\n\t\t\t#在内部把download替换成key\n\t\t\tif instructions['postData']\n\t\t\t\tinstructions['postData'].forEach (item)->\n\t\t\t\t\tif item['name'] is 'key'\n\t\t\t\t\t\tinstructions.download = item['value'];\n\t#\t\tinstructions['postData'][instructions['postData'].length] =\n\t#\t\t\tname: 'x-amz-meta-filename'\n\t#\t\t\tvalue: file.name\n\t\t\tuploader.instructions = instructions\n\t\t\tuploader.transfer(callback);\n\tif Meteor.userId()\n\t\tdummy()\n\telse\n\t\tMeteor.call 'registerGuest',visitor.getToken(),new Tools().getUrlParameterByName('tenant_id'),(err,r)->\n\t\t\tif err\n\t\t\t\treturn showError '注册访客失败！';\n\t\t\tMeteor.loginWithPassword {id:r.user}, r.pass,()->\n\t\t\t\tif err\n\t\t\t\t\treturn showError '访客登录失败！'\n\t\t\t\treturn dummy();\n\n\treturn uploader;\ntypes =      'image\\/*'\ntypes += '|'+'text\\/*'\ntypes += '|'+'audio\\/*'\ntypes += '|'+'video\\/avi'\ntypes += '|'+'video\\/x-mpeg'\ntypes += '|'+'video\\/mpeg4'\ntypes += '|'+'video\\/mpg'\ntypes += '|'+'video\\/x-ms-wmv'\ntypes += '|'+'application\\/msword'\ntypes += '|'+'application\\/pdf'\ntypes += '|'+'application\\/ppt'\ntypes += '|'+'application\\/x-ppt'\ntypes += '|'+'application\\/x-xls'\ntypes += '|'+'application\\/zip'\ntypes += '|'+'application\\/x-zip-compressed'\ntypes += '|'+'application\\/vnd.ms-powerpoint'\ntypes += '|'+'application\\/vnd.rn-realmedia'\ntypes += '|'+'application\\/vnd.rn-realmedia-vbr'\ntypes += '|'+'application\\/vnd.ms-project'\ntypes += '|'+'application\\/vnd.ms-excel'\ntypes += '|'+'application\\/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\ntypes += '|'+'application\\/vnd.openxmlformats-officedocument.wordprocessingml.document'\n@SlingshotAllowedFileTypes = new RegExp(types,'gm')\nuploadFileFilter = (file)->\n\tif file and file.type and file.type.match(SlingshotAllowedFileTypes) and file.size <=10*1024*1024\n\t\treturn true\n\treturn false\n\n@slingshotFileUpload = (files) ->\n\troomId = visitor.getRoom(true)\n\tfiles = [].concat files\n\n\tconsume = ->\n\t\tfile = files.pop()\n\t\tif not file?\n\t\t\tswal.close()\n\t\t\treturn\n\n\t\treadAsDataURL file.file, (fileContent) ->\n\t\t\treturn unless uploadFileFilter file.file\n\n\t\t\ttext = ''\n\t\t\tminType = file.file.type.split('/')[0]\n\t\t\tif minType is 'audio'\n\t\t\t\ttext = \"\"\"\n\t\t\t\t\t<div class='upload-preview'>\n\t\t\t\t\t\t<audio  style=\"width: 100%;\" controls=\"controls\">\n\t\t\t\t\t\t\t<source src=\"#{fileContent}\" type=\"audio/wav\">\n\t\t\t\t\t\t\tYour browser does not support the audio element.\n\t\t\t\t\t\t</audio>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class='upload-preview-title'>#{Handlebars._escape(file.name)}</div>\n\t\t\t\t\"\"\"\n\t\t\telse\n\t\t\t\ttext = \"\"\"\n\t\t\t\t\t<div class='upload-preview'>\n\t\t\t\t\t\t<div class='upload-preview-file' style='height: 200px;background-size: contain;background-repeat: no-repeat;background-position: center;background-image: url(#{fileContent})'></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class='upload-preview-title'>#{Handlebars._escape(file.name)}</div>\n\t\t\t\t\"\"\"\n\n\n\t\t\t#弹出确认框，确认是否上传\n\t\t\tswal\n\t\t\t\ttitle: TAPi18n.__('Upload_file_question')\n\t\t\t\ttext: text\n\t\t\t\tshowCancelButton: true\n\t\t\t\tcloseOnConfirm: false\n\t\t\t\tcloseOnCancel: false\n\t\t\t\thtml: true\n\t\t\t, (isConfirm) ->\n\t\t\t\tconsume()\n\n\t\t\t\tif isConfirm isnt true\n\t\t\t\t\treturn\n\t\t\t\tuserFileUploader = new Slingshot.Upload(\"userFileUpload\",{rid:roomId,filename:file.name});\n\t\t\t\t#先生成id,上传图片之前先插入一条message到本地,只有访客自己可以看到\n\t\t\t\tmsgId = Random.id()\n\t\t\t\tMeteor.call 'sendMessageToLocalLivechat', {\n\t\t\t\t\t\t_id: msgId\n\t\t\t\t\t\trid: roomId\n\t\t\t\t\t\tmsg: \"\"\n\t\t\t\t\t\timageBytes:fileContent\n\t\t\t\t}\n\t\t\t\tTracker.autorun (c)->\n\t\t\t\t\ttarget = document.getElementById('byte-image-'+msgId);\n\t\t\t\t\tprogress = document.getElementById('progress-image-'+msgId);\n\n\t\t\t\t\trate = userFileUploader.progress();\n\t\t\t\t\tif target is null\n\t\t\t\t\t\treturn\n\t\t\t\t\tif progress is null\n\t\t\t\t\t\treturn\n\t\t\t\t\tif isNaN(rate)\n\t\t\t\t\t\treturn\n\t\t\t\t\tif rate is 1\n\t\t\t\t\t\tc.stop();\n\t\t\t\t\t\tprogress.style.width =\"0px\";\n\t\t\t\t\t\treturn\n\t\t\t\t\tprogress.style.width = Math.round(target.offsetWidth*rate)+\"px\";\n\n\n\t\t\t\tsend userFileUploader,file.file, (e,s3key)->\n\t\t\t\t\tif e?\n\t\t\t\t\t\tthrow new Meteor.Error \"Upload File Failed\", \"Upload File Failed\"\n\t\t\t\t\telse\n\t\t\t\t\t\t#把所有的innner header搜集出来，写到数据库中，返回file\n\t\t\t\t\t\turi = 's3r/'+s3key\n\t\t\t\t\t\tif Meteor?.connection?._stream?.rawUrl?.length < 4\n\t\t\t\t\t\t\turi = window.location.protocol+'//'+window.location.host+new Tools().getPath() + uri\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\turi = Meteor.connection._stream.rawUrl + '/' + uri\n\t\t\t\t\t\ts3url =\n\t\t\t\t\t\t\tcontentLength: file.file.size\n\t\t\t\t\t\t\tcontentType: file.file.type\n\t\t\t\t\t\t\ttype:minType\n\t\t\t\t\t\t\tfilename: file.name\n\t\t\t\t\t\t\turi:uri\n\t\t\t\t\t\tif minType is 'audio'\n\t\t\t\t\t\t\ts3url.isRead = false\n\t\t\t\t\t\t\ts3url.duration = Math.ceil $('.upload-preview audio')[0]?.duration\n\t\t\t\t\t\tclienttype ='webchat'\n\t\t\t\t\t\tif Meteor.isCordova is true\n\t\t\t\t\t\t\tclienttype = device.platform\n\t\t\t\t\t\tMeteor.call 'sendMessageLivechatData', {\n\t\t\t\t\t\t\t_id: msgId\n\t\t\t\t\t\t\trid: roomId\n\t\t\t\t\t\t\tmsg: \"\"\"\n\t\t\t\t\t\t\t\t\tFile Uploaded: *#{file.name}*\n\t\t\t\t\t\t\t\t\t#{uri}\n\t\t\t\t\t\t\t\t\"\"\"\n\t\t\t\t\t\t\tfile:\n\t\t\t\t\t\t\t\t_id: file._id\n\t\t\t\t\t\t\tclientType:clienttype\n\t\t\t\t\t\t\ts3url: s3url\n\t\t\t\t\t\t\ttoken: visitor.getToken()\n\t\t\t\t\t\t\tfromWebSite: localStorage.getItem('_3partywebsite')\n\t\t\t\t\t\t},null,(err,result)->\n\t\t\t\t\t\t\t\tconsole.log err\n\t\t\t\t\t\tif S3UpdatedCache[s3key]\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tS3UpdatedCache[s3key] = true\n\t\t\t\t\t\t\tMeteor.call 'updateS3Metadata',s3key,s3url,(e,r)->\n\t\t\t\t\t\t\t\tif e\n\t\t\t\t\t\t\t\t\tconsole.log e\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tconsole.log r\n\n\tconsume()\n\n\n"]}