(function(){

/////////////////////////////////////////////////////////////////////////
//                                                                     //
// client/lib/_visitor.js                                              //
//                                                                     //
/////////////////////////////////////////////////////////////////////////
                                                                       //
// Generated by CoffeeScript 1.10.0                                    //
//定义visitor                                                            //
(function () {                                                         // 3
  this.visitor = new ((function () {                                   // 4
    var getRoom, getToken, register, room, setRoom, token, ticketOrLivechat;
                                                                       //
    function _Class() {}                                               // 7
                                                                       //
    token = new ReactiveVar(null);                                     // 9
                                                                       //
    room = new ReactiveVar(null);                                      // 11
                                                                       //
    /**                                                                //
     *  在浏览器中记录访客信息，visiorToken 是一个 Random                             //
     */                                                                //
    register = function () {                                           // 16
      if (!localStorage.getItem('visitorToken')) {                     // 17
        localStorage.setItem('visitorToken', Random.id());             // 18
      }                                                                //
      return token.set(localStorage.getItem('visitorToken'));          // 20
    };                                                                 //
                                                                       //
    getToken = function () {                                           // 24
      return token.get();                                              // 25
    };                                                                 //
                                                                       //
    setRoom = function (rid) {                                         // 28
      room.set(rid);                                                   // 29
      return localStorage.setItem('visitorRoomId', room.get());        // 30
    };                                                                 //
                                                                       //
    /**                                                                //
     * 获取会话房间，如果不存在则新建房间                                               //
     * @param createOnEmpty                                            //
     * @returns {*}                                                    //
       */                                                              //
    getRoom = function (createOnEmpty) {                               // 38
      var roomId;                                                      // 39
      if (createOnEmpty == null) {                                     // 40
        createOnEmpty = false;                                         // 41
      }                                                                //
      roomId = room.get();                                             // 43
      if (!roomId) {                                                   // 44
        roomId = localStorage.getItem('visitorRoomId');                // 45
        room.set(roomId);                                              // 46
      }                                                                //
      if (!roomId && createOnEmpty) {                                  // 48
        roomId = Random.id();                                          // 49
        setRoom(roomId);                                               // 50
      }                                                                //
      return roomId;                                                   // 52
    };                                                                 //
    //去livechat还是ticket                                                //
    ticketOrLivechat = function () {                                   // 55
      var tenantId = Meteor.settings['public'].tenant_livechat_settings.tenantId || '';
      tenantId = btoa(tenantId);                                       // 57
      Meteor.call('hasActiveAgent', tenantId, function (error, result) {
        if (result) {                                                  // 59
          Session.set("whoEndMsg", "");                                // 60
          FlowRouter.go('index', null, { tenant_id: tenantId });       // 61
        } else {                                                       //
          FlowRouter.go('ticket', null, { tenant_id: tenantId });      // 63
        }                                                              //
      });                                                              //
    };                                                                 //
                                                                       //
    _Class.prototype.register = register;                              // 68
                                                                       //
    _Class.prototype.getToken = getToken;                              // 70
                                                                       //
    _Class.prototype.setRoom = setRoom;                                // 72
                                                                       //
    _Class.prototype.getRoom = getRoom;                                // 74
                                                                       //
    _Class.prototype.ticketOrLivechat = ticketOrLivechat;              // 76
                                                                       //
    return _Class;                                                     // 78
  })())();                                                             //
}).call(this);                                                         //
/////////////////////////////////////////////////////////////////////////

}).call(this);
