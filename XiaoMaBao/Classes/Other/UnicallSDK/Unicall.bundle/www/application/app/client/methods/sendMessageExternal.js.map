{"version":3,"sources":["meteor://üíªapp/client/methods/sendMessageExternal.js"],"names":[],"mappings":"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","file":"/client/methods/sendMessageExternal.js","sourcesContent":["// Generated by CoffeeScript 1.10.0\n(function() {\n  Meteor.methods({\n    sendMessageLivechat: function(message) {\n      if(!Session.get(\"hasSendMsg\")){\n        Session.set(\"hasSendMsg\", true);\n      }\n      message.ts = new Date(Date.now() + (TimeSync.isSynced()?TimeSync.serverOffset():0));\n      message.u = {\n        _id: Meteor.userId(),\n        username: 'visitor',\n        name: 'visitor'\n      };\n      if(message.temp === undefined)\n        message.temp = true;\n      if(ChatMessage.findOne({_id:message._id})){\n        return ChatMessage.update(message);\n      }else{\n        return ChatMessage.insert(message);\n      }\n    },\n    sendMessageToLocalLivechat: function(message) {\n      message.ts = new Date(Date.now() + TimeSync.serverOffset());\n      message.u = {\n        _id: Meteor.userId(),\n        username: 'visitor',\n        name: 'visitor'\n      };\n      return ChatMessage.insert(message);\n    },\n    sendMessageLivechatData:function(data,callback){\n      function dummy(){\n         if(!data._id){\n           data._id =  Random.id();\n         }\n        // if(!data.rid){\n           data.rid=visitor.getRoom(true);\n        // }\n        Meteor.call('sendMessageLivechat', data, function(err, result) {\n          if (err) {\n            ChatMessage.update(msgId, {\n              $set: {\n                error: true\n              }\n            });\n            return showError('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•ÔºÅ');\n          }else{\n            if(result){\n              if(result.rid && visitor.getRoom() !== result.rid) {\n                csvControler.onRoomChanged(result.rid);\n              }\n              if(result.type !== \"merchandise\")\n                if(ChatMessage.findOne({_id: result._id})) {\n                  var properties  ={};\n                  for(var i in result){\n                    if(i !=='_id'){\n                      properties[i] = result[i];\n                    }\n                  }\n                  properties.temp = false;\n                  ChatMessage.update({\n                    _id: result._id\n                  }, {$set:properties});\n                }else{\n                  ChatMessage.insert(result);\n                }\n              if(callback)callback();\n            }\n\n          }\n        });\n      }\n      var sysMsg = outerAgent.recoverUniqueSystemMessage();\n      if(sysMsg){\n        //sysMsg._id =  Random.id();\n        //sysMsg.rid = data.rid;\n        function innerDummy(){\n          sysMsg.temp = false;\n          Meteor.call('sendMessageLivechatData',sysMsg,function(){\n            setTimeout(dummy,50);\n          },function(){})\n        }\n        setTimeout(innerDummy,50);\n      }else{\n        setTimeout(dummy,50);\n      }\n    }\n  });\n\n}).call(this);\n\n"]}